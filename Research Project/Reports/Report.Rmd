---
title: "A Contemporary Reevaluation of Relative Affordability in the American Housing Market"
subtitle: "DATA698-004 Capstone Project Mid-Term Draft"
author: "Zachary Palmore"
output:
  bookdown::pdf_document2:
    css: styles.css
    fig_caption: yes
    theme: flatly
    toc: yes
    toc_depth: 1
bibliography: library.bib
link-citations: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```


## Introduction 

```{r}
# Packages 
library(tidyverse)
library(ggpubr)
library(kableExtra)
theme_set(theme_minimal())
```

It is important that housing be affordable because people need a place to live. Failure to provide adequate affordable housing has been shown to weaken local economies, reduce quality of life, and increase financial and mental health stress in the population. We note the two major national indices that focus on estimating a qualifying income as a proportion of the median family income for a given area to measure affordability. While these incorporate interest rates and make reasonable assumptions about down payments, amortization, and other general requirements for consumers to be granted a mortgage loan, they leave out a plethora of obstacles faced by consumers, especially for first-time homebuyers. Instead, focus should be placed on direct consumer access to housing without loan considerations and incorporate a reasonable safety net in these index calculations. We propose a new method of calculating housing affordability for consumers in the 21st century, one that incorporates a set of minimum thresholds that better exemplify the economic challenges of the modern home buying process. 

There are two main indices used to calculate housing affordability in the United States, the National Association of Realtors (NAR) Housing Affordability Index and the California Association of Realtors (CAR) Index. When these national methods are applied at the city or county level it is considered a Local Housing Affordability Index (LHAI). We intend to focus on U.S. metropolitan statistical areas (MSAs) to make well known the local affordability challenges. These major indices fail to consider the full scope of challenges that potential homebuyers, especially first-time homebuyers, face when making the decision to purchase a home. The formula for the home affordability index (HAI) is as follows: 

 

$$HAI = ( \frac{Median\hspace{4pt} Family\hspace{4pt} Income }{\hspace{4pt}Qualifying\hspace{4pt}Income\hspace{4pt} }) \times 100$$ 

 

Where the qualifying income value contains assumptions about the down payment, average federal mortgage interest rate, principal, interest on the loan, taxes (including property taxes), insurance, with the last four building the acronym PITI. The CAR Index incorporates a minimum income needed to qualify for the loan and income distribution of the area but is unique by focusing on locations in California. In both cases, applying this equation to incomes at local levels improves our understanding of how affordable the area is but is narrowly focused on the average consumer’s income having little if any debts or financial obligations. However, debt and financial obligations are realities of modern life. 

For example, consumers who are of home buying age (25+) are mostly millennials which according to the 2020 Experian State of Credit report means they have an average of about $27,251 in non-mortgage debts. It is important to understand that when the parents of these millennials (Colloquially Gen X’s and Baby Boomers) were purchasing houses, they had far fewer non-mortgage debts on average, were often given generous loans while needing fewer qualifications, and could have used the same amount of non-mortgage debts as millennials towards down-payments. Such an amount in their times would have more than covered the necessary upfront costs of becoming homeowners. Today, this is not the case. Lending practices have tightened, and costs have increased while the income of millennials has stabilized. These factors must be considered in the affordability index since they act as barriers to ensuring access to comparable housing. 

In the United States the average cost to purchase a house has continuously increased since at least 1921 when the Bureau of Labor Statistics (BLS) began collecting data on the Consumer Price Index, or CPI, which included housing costs. As with all consumer goods, inflation has been a significant factor contributing to this increase in house prices. Market adjustments in personal and household income have also been made in response to inflation, generally increasing an individual’s gross income. Overall, this has raised the chances of homeownership in the U.S. through the collection of individuals who chose to save money, reduce their debts, and leverage credit to finance their homes with mortgages. This trend has lowered the upfront costs needed to purchase a house while simultaneously limiting the burden placed on some homeowners who lack the means to afford their house on their own. Unfortunately, today, there is far more to purchasing a house than simply having enough money. For most Americans, becoming homeowners is a process. 

Consider that it is a standard recommendation by financial institutions that any mortgage bearer not consume more than 28% of that person’s monthly gross income on a monthly mortgage payment. In real dollars, this means if you make \$5,000 in a month, you should not pay more than \$1,400 on your mortgage payment. Additionally, the individual interested in purchasing a house using a mortgage, should expect to make a down payment on that house. Amounts vary by lender and the federal government has several programs available to assist prospective homebuyers should they fulfill the requirements of the program. For the average American these range from as low as 3% to 10% minimum down payments on government-backed specialty and conventional home loans. These are common among first-time home buyers. Private loans, however, require 20% as a minimum unless the individual has their mortgage insured. This makes understanding the home-buying process quite difficult and approval in any case is also dependent upon credit, existing real assets, financial assets, and other forms of wealth. 	 

Evidence suggests that housing today is much less affordable than it was over the past century. In the 1920’s it was common for an individual to purchase a home without a mortgage. Instead, the individual would pay for the house outright, fully owning the home and its property upon transfer of the deed. According to James L. Butkiewicz, an economics professor at the University of Delaware, the first home loans were typically fixed short-term loans of 3 - 5 years in length and given for no more than 50% of the value of the property. This trend of loaning less than half the value of the home for short-terms lasted through much of the 1900’s until reforms were created in an attempt to stabilize the market. These methods are impractical or impossible for most Americans in the first two decades of the 21st century because we have failed to comprehend the magnitude of the problem; that is, owning homes has become less attainable for each subsequent generation since the 1980’s.

During the years 2020 and 2021, there was a surge in home buying fueled by the reactions of businesses and employees to work remotely and relocate, often to locations with a lower cost of living. Anecdotal accounts of reasons these people decided to move ranged from their location not being as valuable to them due to mandatory quarantines, to moving out a little sooner than planned. The economic outcomes of this shift resulted in a rapid increase of home prices. There simply was not enough supply of new homes to meet the demand of consumers in the market. To further worsen relative affordability for potential homeowners, there was also a lumber shortage and multitude of supply chain issues that intensified the process. It was completely unconventional of extant generational experiences and led to bidding wars and houses selling minutes after they hit the market prior to the buyer ever stepping foot on the property. This had the greatest effect on those just entering the market, namely millennials. It is unclear how this may affect future generations, but an improved housing affordability index may help to mitigate risks to consumers and local economies.

Our hypothesis is that improving upon the housing affordability index will increase understanding among financial institutions and municipalities to empower prospective homebuyers in their areas. With an improved relative affordability measure, efforts to mitigate homelessness, reduce financial stress, increase quality of life, and boost economies can occur at national, state, and local levels. By incorporating a safety net within the calculations of housing affordability, especially for metropolitan statistical areas, we can focus directly on the consumer’s access to housing and evaluate how comparable it is to that of previous generations. 

 

## Literature Review 

Housing affordability is a significant contributing factor when determining the level of economic development and market stability in a country.9 For over a century, policy experts and analysts have targeted economic factors as the most important determinants of how to make housing more affordable.13 While this is supported by a larger share of historical publications than recent sustainability-focused socioeconomic examples, there has been a rapid increase since 1995 in the volume of literature concerning affordable housing.17 These papers have a wide range of definitions for what affordable housing is but nevertheless have exposed conventional economic hypotheses as having only scratched the surface of how to accurately calculate housing affordability.4  

A cross-disciplinary review of existing literature on affordable housing in 2012 noted that it is widely accepted “among policy analysts that an inadequate supply of affordable rental and owner-occupied housing can lead to a number of negative social outcomes.”15 Current reviews of the literature from peer-reviewed articles to public releases of industry reports and data, found this remains the case.17 Failure to provide even adequate housing has been shown to create circumstances that force households into lower economic classes and in some cases, poverty. Whereas any marked improvements in how we measure housing affordability, could lead to positive outcomes for society and individuals alike through policy and market-based resolutions. Such documented outcomes include “enhanced housing and transportation infrastructure, income adequacy, household wellbeing, reduced inequalities and improved rental housing” as well as access to new opportunities.9  

There is also a consensus that we must include additional costs consumers face to fully understand housing affordability.11 One example of this comes from studies that include household transportation expenses to create another index known as the location affordability index (LAI). The U.S. Department of Housing and Urban Development (HUD) filled a database with information on affordability by location and developed a method to estimate the LAI. While this has caused major improvements in public and private assessments of affordability, its reliability remains in question. Studies have shown that at census-tract level aggregation, LAI models tend to overestimate costs, especially for renters.11 Due to the unreliability in its aggregation, variable construction, and modeling methods, some studies have claimed “reliability metrics for the Journey to Work (JTW) data on transit use warrant jettisoning these data altogether” citing ethical reasons as well.10 Here again, there is also disagreement on how to calculate these satellite variables of the overall housing affordability index.6 Other studies have made it clear that an optimal measurement that precisely estimates the true value of affordability, especially at local levels, remains a major concern.3,7,9  

As the direct costs of housing have increased on average across the United States, research efforts to address the growing concern of housing affordability have also tried to identify and deescalate the severities of the sources of the problem.5,8,16 While many have achieved success in identifying criteria thought to cause housing affordability, new challenges have raised alarm over the definition of affordable housing and how results differ depending on how it is measured.17 These criteria are considered critical success factors.  

According to a study published in the journal Building and Environment there are 13 critical success factors (CSFs) relevant to ensuring sustainable affordable housing.1These CSFs stem from a survey of affordable housing experts who responded to a questionnaire with 30 unique success factors identified from their review of existing literature in 2019. Responses were compiled and researchers were able to rank the experts’ agreement with each other on each unique success factor and found underlying patterns. Among those patterns they found the main obstacle was “political will and commitment to affordable housing” but the second highest consideration was the “formulation of sound housing policies.” As shown through records of housing affordability indices and reviews of the literature, forming sound housing policies is heavily influenced, and some might even say dependent on, the accuracy of the estimates themselves. These results have been reaffirmed through various surveying and policy simulation modeling methods in subsequent studies.9,17  

Experts in housing policy and urban studies tend to calculate housing affordability indices as the “average share of households paying more than 30 percent of their income for shelter.”6 According to the National Association of Realtors, the Joint Center for Housing Studies at Harvard, and other peer-reviewed sources, this is the most widely accepted metric for estimating housing affordability.3,14,18 The Joint Center for Housing Studies also states that when household spending exceeds this threshold, it is reasonable to expect that they do not have enough to afford other necessities. This is an important distinction from other sources of existing literature, which tend to have a broader definition such as “the relationship between housing and its users” 3 and those interested in examining the interdependencies of housing and health.2,19 

Based on studies of global housing markets it is clear that in order to develop a better, more robust metric that is useful to both consumers and policymakers in understanding and addressing housing affordability, it is necessary to build on existing standards and data sources.1,12,13 There are well-understood relationships between housing affordability and housing cost, transportation, cost of living, and other variables and these should be used to determine an ideal measurement approach.1,15,19 Despite the exponential growth of research on the measurement and concept of housing affordability, there remains concerns over the reliance of conventional methods to inform and reform weaknesses in policy instruments.3,4,9 Current literature reiterates the need for better methods of conceptual analysis on, and physical estimations of, housing affordability to bring new insights to the field in a transparent, less data intensive manner.  

## Methodology 

```{r}
# Read in Data 
df <- read.csv("https://raw.githubusercontent.com/palmorezm/msds/main/698/Data/compiled.csv")
# Change Data Types to Numeric
df[4:length(df)] <- sapply(df[4:length(df)], as.numeric)
df <- df %>% 
  dplyr::select(-X)
```

We define affordable housing as the potential of the median household in a given area to finance or purchase a house at or above that area’s average house cost threshold wherein the median household has enough income leftover to afford other commonly purchased expenditures. As mentioned, there are many perspectives regarding what affordable housing means. To cover the topic at a reasonable depth, and to consider multiple affordability strategies, we develop 7 housing affordability indices (HAIs) based on the literature and available data. There is consensus that focus should be on creating metrics that are widely applicable, require relatively little computational power, and build on existing data. Ideally, these metrics would also be transparent for the public and policymakers alike. We adhere to these principles when developing our own adjusted HAI metrics.   

Our original data comes from publicly accessible institutions including The United States Bureau of Economic Analysis (BEA) and their partnership projects with the Bureau of Labor Statistics (BLS) along with a mixed set of parameters created by the U.S. Census Bureau. These datasets each contain 1 or more of 15 essential variables that we use to calculate relevant HAI statistics. Our final dataset contains 43 variables with 28 created from separate computations used in the HAI adjustments. This final dataset and its original data sources, merging, and joining processes, are linked in the appendix for reference and open-source reproducibility.  

We focus our efforts on localizing the HAI and utilizing relevant information at the level of metropolitan statistical areas (MSAs). As defined by the Census Bureau, an MSA is “one or more counties that contain a city of 50,000 or more inhabitants or contain a Census Bureau-defined urbanized area (UA) and have a total population of at least 100,000 (75,000 in New England).” It also noted that MSAs contain a population nucleus as its core with a “high degree of economic and social integration with that core.” In 2019, approximately 83% of the U.S. population lived in these urbanized metropolitan areas with an average population density of 283 people per square mile. The national average population density was about 94 for the same year. Urbanization and the growth of MSA has steadily increased in population and size (to include more counties) for over a century. Because of this, we can be confident that our methods capture at least 83% of the U.S. population but do not capture the full spread of its area.  

These statistics show distinct gaps between where people are concentrated and where people are spread out and result in vastly different challenges to housing affordability outside of metropolitan areas. We note this but do not adjust for the differences in our 7 adjusted HAI estimates due to calculations that incorporate nationally smoothed values. These would not serve micropolitan or other smaller statistical areas. Outside of MSA (where at least 83% of the population resides), the HAI is less flexible.  

Mathematically, we can write out these 7 HAI estimates as equations. All methods use a fixed 30-year interest rate of 3.5% which according to major lending services, is currently closest to the market average. In the interest of making our HAI’s widely applicable, transparent, and useful to a broader audience, we include exact specifications of each new version of HAI and build on the national standard. 

These methods can be reduced to the following equations:

$$National\hspace{4pt}Association\hspace{4pt}of\hspace{4pt}Realtors\hspace{4pt}(NAR)\hspace{4pt}Method$$

$$(\frac{M_{i}}{(\frac{M_{p}\times0.8( \frac{IR}{12} )}{ 1- ( \frac{1 + IR}{12}   )^{360}} *48 )} )\times100$$

Where $Mi$ is the median household income for each MSA, 
$M_{v}$ is the median home value for the same MSA, and $IR$ is a fixed interest rate. We make a slight adjustment to this to create a real wage using regional price parities for each MSA provided by BEA.  

$$Regional\hspace{4pt}Price\hspace{4pt}Parity\hspace{4pt}(RPP)\hspace{4pt}Adjusted\hspace{4pt}Income\hspace{4pt}(Real\hspace{4pt}Wage)\hspace{4pt}HAI$$

$$(\frac{M_{i} - (   (\frac{R_{all}}{100})\times M_{i} )  }{(\frac{M_{p}\times8( \frac{IR}{12} )}{ 1- ( \frac{1 + IR}{12}   )^{360}} *48 )} )\times100$$

With $R_{all}$ representing the regional price parities for each MSA of the entire basket of goods and services surveyed by the BEA and the BLS. The rest of the equation went unchanged effectively allowing us to estimate the HAI with a ‘real wage,’ that is, the income leftover after adjusting for cost of living per MSA.  

$$Rent\hspace{4pt}Adjusted\hspace{4pt}HAI$$

$$(\frac{M_{i} - (   (\frac{R_{rent}}{100})\times M_{i} )  }{(\frac{M_{p}\times0.8( \frac{IR}{12} )}{ 1- ( \frac{1 + IR}{12}   )^{360}} *48 )} )\times100$$

In this case, we isolate the most integral category of the regional price parities of MSAs, which is rent. These results could be interpreted as part of the route to homeownership since renting a place is often necessary before purchasing with a mortgage or other financial commitment outside of leasing.  

$$Implicity\hspace{4pt}Regional\hspace{4pt}Price\hspace{4pt}Deflator\hspace{4pt}(IPD)\hspace{4pt}Projected\hspace{4pt}HAI$$

$$(\frac{   (\frac{I_{rw} + I_{rt} }{2})\times  \frac{IPD}{100} )  }{(\frac{M_{p}\times0.8( \frac{IR}{12} )}{ 1- ( \frac{1 + IR}{12}   )^{360}} *48 )} )\times100$$

The Implicit Regional Price Deflator (IPD) for MSAs is a “regional price index derived as the product of two terms: the regional price parity and the U.S. PCE price index” in which “growth rate or year-to-year change in the IRPDs is a measure of regional inflation.” We use this growth rate to project where the average between real personal income ($I_{rw}$) and rent adjusted incomes ($I_{rt}$) would be and create an HAI as if housing prices were stagnant.  


$$Raw\hspace{4pt}HAI$$

$$(\frac{M_{i}}{(\frac{M_{p}\times0.99( \frac{IR}{12} )}{ 1- ( \frac{1 + IR}{12}   )^{360}} *48 )} )\times100$$

This Raw HAI considers how affordable housing would be if the individual were able to have 99% of the value of the home financed at a fixed interest rate for 30 years. 

$$Outstanding\hspace{4pt}Debts\hspace{4pt}HAI$$

$$(\frac{(\frac{I_{rw} + I_{rt}} {2}) - \sum{(D_{mv}/h),(D_{ed}*h), (D_{il}*h), (D_{cc}*h), (D_{oc}*h) }}{(\frac{M_{p}\times0.99( \frac{IR}{12} )}{ 1- ( \frac{1 + IR}{12}   )^{360}} \times \frac{100}{30}\times12   )} )\times100$$


For the outstanding debts HAI only consumer debt is considered. No mortgages or home equity loans are included in consumer debt. These debts are averages for the American individual and as such are adjusted to fit household dollars. There are 5 kinds of debt in our formula, each of which are representative of the median for their category. They include motor vehicle debt at roughly \$20,000 per household, education debt (which includes student loans) at \$9,664 for each individual in a household under 40 years of age, debts from installment loans at \$9,609 per individual on average, credit card debt at \$3,500 per individual, and all other debts from medical expenses, leans against pensions, life insurance, payday loans, and more lumped into one category at about $10,000 per individual. The average household size (h) is 2.53 based on the 2020 Census Bureau’s decennial census. We expand the loan allowance here increasing the lending leniency to 30% of monthly personal income for the average household to compensate for the additional debts and give as much tolerance as possible with current lending practices.  

$$Lenient\hspace{4pt}Lending\hspace{4pt}HAI$$

$$(\frac{M_{i}}{(\frac{M_{p}\times0.97( \frac{IR}{12} )}{ 1- ( \frac{1 + IR}{12}   )^{360}} \times (\frac{100}{60})\times12 )} )\times100$$

To stretch lending practices even further, a concept which has been argued would improve housing affordability while increasing market instability, we adjust the median value of the mortgage loan to account for 97% of the value of the home. This indicates that the individual would only need to pay 3% of the home value for a down payment. Then, we reevaluate the qualifying income of the HAI to allow greater flexibility in how much the average consumer could pay to 60% of their monthly income being spent on their monthly mortgage payment. 


Within each of these HAIs we have a particular purpose and tactic to better calculate housing affordability. In all cases, our interest rate is held constant to attribute changes to the formula rather than state and federal loan rates. The NAR method serves as our control, and it follows the same formula as the national standard setup by the National Association of Realtors. Since the housing data collected contains estimated valuations by homeowners (which is not an exact estimate of home values), we need a base sample to build upon and measure deviations from. Unfortunately, the national association of realtors does not allow data sharing or open-source use without randomization of the MSA from their respective HAI’s. This is not valuable to us since this would remove the opportunity for the public and policymakers to identify their locality and thereby eliminate the potential for improvements.  

The remaining HAI methods rely on adjustments to median household income with the same qualifying income as the NAR HAI except when calculating the Outstanding Debts HAI and Lenient Lending HAI. The first adjustment simply creates a real wage estimate for the locality by adjusting for the cost of living. This integrates a median dollar adjustment derived from the national average for a market basket of goods and services including prices for transportation, food, rent, and other categories. We isolate rent in the Rent Adjusted HAI and adjust the median household income proportionally for each MSA. Next, we use the implicit regional price deflator for each MSA to create an IPD Projected HAI that incorporates wage growth with a theoretically stabilized housing market. Our Raw HAI weighs the influence of down payments on affordability by increasing the expected loan amount to 99% of the median home value. Lastly, we identify the average household debts from the literature to form an Outstanding Debts HAI and form a new Lenient Lending HAI by hypothetically easing lending restrictions.   
Importantly, the data used to form these HAI estimates are collected and updated at regular frequencies and averaged (by median) across 5-year intervals. This limits volatility within the data, making it less biased and more robust. Our study spans from 2010 through 2019, or one decade. Traditionally, the ‘cap’ of household income that could be reasonably spent on housing was 30% of household income. We lower this in all but two of our calculations where it makes intuitive sense to reflect present lending practices. We also assume that every household is capable of making a 20% down payment. We note that this is highly unlikely and is why government programs exist to assist individuals with lowering the up-front costs of purchasing a home. Nevertheless, because it is a standard of the industry and lending institutions, we focus on changes to income that could affect housing affordability.  

To elucidate upon the effects of each HAI method we model their distributions across income and population by MSA. The relationship between the population and our newly formed median HAI affordability model is such that we can state half of the population is below the HAI value and half is above. We take advantage of this relationship and available literature to estimate the proportion of the population that is unable to afford housing. We also compare rates of change in personal and real wage income to the change in housing affordability at various HAI levels. This allows us to use linear regression techniques to model changes by HAI method and predict where their metrics are heading as well as approximate how many people could afford housing in the future.

```{r}
# All HAI Estimates
df.fin <- df %>% 
  mutate(IR = 0.035, 
         PMT = MEDVAL * 0.8 * (IR / 12)/(1 - (1/(1 + IR/12)^360)), 
         QINC = PMT * 4 * 12,
         HAI = (MEDINC / QINC) * 100) %>% 
  mutate(ADJALL = (MEDINC - ((RPPALL / 100)* MEDINC)),
         AINCALL = MEDINC + ADJALL, 
         # Real Wage HAI:
         HAIRW = (AINCALL / QINC)*100) %>% 
  mutate(ADJRNT = (MEDINC - ((RPPRENT / 100)* MEDINC)), 
         AINCRNT = MEDINC + ADJRNT, 
         # Rent Adjusted HAI:
         HAIRNT = (AINCRNT / QINC)*100) %>% 
  mutate(ADJIPD = (AINCRNT + AINCALL / 2)*(IPD/100),
         # IPD Projected HAI:
         HAIIPD = (ADJIPD / QINC)*100) %>% 
  mutate(PMTRAW = MEDVAL * 0.99 * (IR / 12)/(1 - (1/(1 + IR/12)^360)), 
         QINCRAW = PMTRAW * 4 * 12,
         # Raw HAI at 20% Down Payment:
         HAIRAW = (MEDINC / QINCRAW) * 100) %>% 
  mutate(HHSIZE = 2.53, 
         DEBTMV = (20000/HHSIZE),
         DEBTED = 9664*HHSIZE, 
         DEBTIL = 9609*HHSIZE,
         DEBTCC = 3500*HHSIZE, 
         DEBTOC = 10000*HHSIZE, 
         DEBTS = DEBTMV + DEBTED + DEBTIL + DEBTCC + DEBTOC, 
         AQINC30 =  PMT * (100/30) * 12,
         AINCDBT = ((AINCRNT + AINCALL / 2) - DEBTS), 
         # HAI Adjusted for Average American Household Debts
         HAIDBT = AINCDBT / AQINC30) %>% 
  mutate(PMT3DP = MEDVAL * 0.97 * (IR / 12)/(1 - (1/(1 + IR/12)^360)),
         AQINC60 = PMT * (100/60)*12,
         # Lenient Lending Practices HAI 
         #(60% of monthly income on mortgage is acceptable with 3% DP)
         HAILEN = (AINCALL / AQINC60)*100) 
```




## Results 




```{r}
# Count Missing Values
df.missingvalues <- df.fin %>% 
  gather(key, value, -GeoFips, -GeoName, 
         -year, -MEDINC, 
         -MEDVAL, -MOE, 
         -UMEDVAL, -LMEDVAL, 
         -POP, -PERINC, -AINCALL) %>%
  filter(key == c("HAI", "HAIRW", 
                  "HAIRNT", 
                  "HAIIPD", 
                  "HAIRAW", 
                  "HAILEN", 
                  "HAIDBT")) %>%
  summarise(sum(is.na(value))) 
# Extract HAIs < 100
ltdf <- df.fin %>% 
  gather(key, value, -GeoFips, -GeoName, 
         -year, -MEDINC, 
         -MEDVAL, -MOE, 
         -UMEDVAL, -LMEDVAL, 
         -POP, -PERINC, -AINCALL) %>%
  filter(key == c("HAI", "HAIRW", 
                  "HAIRNT", 
                  "HAIIPD", 
                  "HAIRAW", 
                  "HAILEN", 
                  "HAIDBT")) %>% 
  subset( value < 100) 
# Extract HAIs >= 100
gtdf <- df.fin %>% 
  gather(key, value, -GeoFips, -GeoName, 
         -year, -MEDINC, 
         -MEDVAL, -MOE, 
         -UMEDVAL, -LMEDVAL, 
         -POP, -PERINC, -AINCALL) %>%
  filter(key == c("HAI", "HAIRW", 
                  "HAIRNT", 
                  "HAIIPD", 
                  "HAIRAW", 
                  "HAILEN", 
                  "HAIDBT")) %>% 
  subset( value >= 100) 
# Summarize by group the "less affordable" population and other statistics 
lttbl <- ltdf %>%
  group_by(key, year) %>% 
  na.exclude() %>%
  summarize(Set = 'LT100', 
            N = n(), 
            MMEDHAI = median(value), 
            AAVGHAI = mean(value),
            SMEDINC = sum(MEDINC),
            SMEDVAL = sum(MEDVAL),
            SUMEDVAL = sum(UMEDVAL), 
            SLMEDVAL = sum(LMEDVAL), 
            SPERINC = sum(PERINC), 
            SREALWAGE = sum(AINCALL), 
            TPOP = sum(POP), 
            TPOPN = (TPOP/N), 
            PMEDINC = (SMEDINC/N),
            PMEDHAI = (MMEDHAI/N),
            PAVGHAI = (AAVGHAI/N) )
# Summarize by group the "more affordable" population and other statistics 
gttbl <- gtdf %>%
  group_by(key, year) %>% 
  na.exclude() %>%
  summarize(Set = 'GT100', 
            N = n(), 
            MMEDHAI = median(value), 
            AAVGHAI = mean(value),
            SMEDINC = sum(MEDINC),
            SMEDVAL = sum(MEDVAL),
            SUMEDVAL = sum(UMEDVAL), 
            SLMEDVAL = sum(LMEDVAL), 
            SPERINC = sum(PERINC), 
            SREALWAGE = sum(AINCALL), 
            TPOP = sum(POP), 
            TPOPN = (TPOP/N), 
            PMEDINC = (SMEDINC/N),
            PMEDHAI = (MMEDHAI/N),
            PAVGHAI = (AAVGHAI/N) )
# Check Row Observations Match Data in Glb Env.
# sum(gttbl$N) 
# sum(lttbl$N)
d <- rbind(lttbl, gttbl) 
d.columns <- d %>% 
  ggplot(aes(year, (TPOP/1000000), fill=Set)) + 
  geom_col(col = "grey38", alpha= 0.25) + 
  scale_x_discrete(limit = c(2010, 2015, 2019)) + 
  theme(axis.text.x = element_text(angle = -0), 
        axis.ticks = element_line(size = .5) ) + 
  facet_wrap(~key, scales = "fixed")
# Create shifting function to move index values of column in d upwards by n 
shift <- function(d, n){
  c(d[-(seq(n))], rep(NA, n))
}
# Summarize with filtering
data <- d %>% 
  dplyr::select(key, year, Set, N, TPOP, TPOPN, SMEDVAL, SUMEDVAL, PMEDINC, PMEDHAI, PAVGHAI) %>% 
  filter(Set == 'LT100' & year == 2010 | year == 2019) %>% 
  filter(Set != 'GT100') %>% 
  mutate(SKEW = PAVGHAI - PMEDHAI, 
         MOE = ((SUMEDVAL - SMEDVAL)/N), 
         C2019 = ifelse(year == 2019, TPOP, NA), 
         C2010 = ifelse(year == 2010, TPOP, NA))%>% 
  dplyr::select(-PAVGHAI, -Set, -TPOPN, -SMEDVAL, -SUMEDVAL)
data$C2010 <- shift(data$C2010, 1)
data <- data %>% 
  mutate(CHANGE = C2019-C2010) %>% 
  dplyr::select(-C2010, -C2019) %>%
  mutate(CHANGE = replace_na(CHANGE, 0))
data <- as.data.frame(data) 
percent_pop_MSA <- 0.83
censuspop2019 <- 328300000
```


Estimates based on the NAR method found that in 2019 approximately `r sum(data$TPOP)` people, or `r round((sum(data$TPOP)/(censuspop2019*percent_pop_MSA))*100, 2)`% of the U.S. MSA population would be unable to afford housing when adhering to traditional financial conventions. Such commonly held conventions include no household paying more than 28% of their monthly income to their monthly mortgage payment and the assumption that everyone must make a 20% down payment at a constant, 30-year fixed interest rate of 3.5%. This was an decrease by `r abs(data$CHANGE[2])` people from 2010. Other methods show variations with as few as `r min(data$TPOP)` unable to afford housing using our lenient lending method and as many as `r max(data$TPOP)` when considering household debts. A table of relevant statistics and their change from 2010 to 2019 is shown for reference. 


```{r}
# display table
data
```

The proportion of the population that is unable to afford housing varies by HAI. In accordance with the NAR methodology, we structured our HAI methods such that any value greater than or equal to 100 is considered affordable. By the same notion, anything less than 100, is less than affordable. In the following figure we notice that the majority of MSA are still able to afford housing. This is noted by the red coloration in the figure. Meanwhile, blue (less than affordable) is largely a minority in all but the HAIDBT method where household debts are factors in affordability. We also notice the levels of affordability change at different rates during the timespan. Our methods are both above and below the NAR method depending on which variables are focused on. 

```{r}
data.popchangecolumns <- data %>% 
  ggplot(aes(year, (TPOP/1000000), col = key, alpha = .25)) + 
  geom_col(fill = "white") + 
  facet_wrap(~key, scales = "free_y") + 
  scale_x_discrete(limit = c(2010, 2019))
d.columns 
```

Excluding our NAR method, we developed 6 alternative methods to better exemplify the modern home-buying process, each with a focus on a particular variable of interest or subset of variables that are currently understood to influence the housing market and its relative affordability at local levels. To better understand the effects of each HAI method and its relationship to population and income, we examine where the distribution of MSA affordability values fall in relationship to a benchmark denoting where housing is considered affordable (100) alongside each MSA’s median household income from 2010 through 2019. This benchmark is shown as a vertical dot-dashed black line. Anything to the right of the line is affordable while MSA values to the left of the line are less affordable. We also add linear trendlines to the top 6 plots and a locally estimated scatterplot smoothing (LOESS) line to two supplemental plots of our abnormally unaffordable outstanding debts HAI. 

```{r}
# Real Income and HAI's
# create a title list for HAI
HAINAMES <- list("Normal" = "HAI", "Real Wage"="HAIRW", "Rent Adjustment"="HAIRNT", 
                 "Inflation Adjusted"="HAIIPD", "Raw Values"="HAIRAW", "Lenient Lending"="HAILEN")
hainames <- c("HAI" = "Normal", 
              "HAIRW"="Real Wage", 
              "HAIRNT"="Rent Adjusted", 
              "HAIIPD"="Inflation Adjusted", 
              "HAIRAW"="Raw Values", 
              "HAILEN"="Lenient Lending")
HAItitle <- function(variable,value){
  return(HAINAMES[value])
}
# Main 6 HAIs labeled Scatterplot Trends
main6 <- df.fin %>%
  gather(key, value, -GeoFips, -GeoName, -year, -MEDINC, 
         -MEDVAL, -MOE, -UMEDVAL, -LMEDVAL, -POP, -PERINC, -AINCALL) %>%
  filter(key == c("HAI", "HAIRW", "HAIRNT", 
                  "HAIIPD", "HAIRAW", "HAILEN")) %>% 
  filter(AINCALL <100000) %>% 
  ggplot(aes(value, (AINCALL/1000))) + 
  geom_point(aes(x = value, alpha = .01, col = key)) + 
  geom_vline(xintercept = 100, lty = "dotdash", col = "black") + 
  geom_smooth(aes(x = value), 
              method="lm", col = "grey30", fill = "light grey",
              se = T, na.rm = T) + 
  labs(x = "Home Affordability Value", y = "Median Income ($1000)") +
  facet_wrap(key ~ ., scales = "free_x", shrink = F, labeller = labeller(key = hainames)) + 
  theme(legend.position = "none")
# Outstanding Debts HAI ScatterPlot Trends
dbts1 <- df.fin %>%
  gather(key, value, -GeoFips, -GeoName, -year, -MEDINC, 
         -MEDVAL, -MOE, -UMEDVAL, -LMEDVAL, -POP, -PERINC, -AINCALL) %>%
  filter(key == c("HAIDBT")) %>% 
  filter(AINCALL <100000) %>% 
  ggplot(aes(value, (AINCALL/1000))) + 
  geom_point(aes(x = value, alpha = .01, col = key)) + 
  geom_vline(xintercept = 100, lty = "dotdash", col = "black") + 
  geom_smooth(aes(x = value), 
              method="loess", col = "grey30", fill = "light grey",
              se = T, na.rm = T) + 
  labs(x = "Home Affordability Value", y = "Median Income ($1000)", 
       title = "Outstanding Debts HAI Distribution") +
  theme(legend.position = "none", 
        plot.title = element_text(hjust = .5)) 
dbts2 <- df.fin %>%
  gather(key, value, -GeoFips, -GeoName, -year, -MEDINC, 
         -MEDVAL, -MOE, -UMEDVAL, -LMEDVAL, -POP, -PERINC, -AINCALL) %>%
  filter(key == c("HAIDBT")) %>% 
  filter(AINCALL <100000) %>% 
  ggplot(aes(value, (AINCALL/1000))) + 
  geom_point(aes(x = value, alpha = .01, col = key)) +
  geom_smooth(aes(x = value), 
              method="loess", col = "grey30", fill = "light grey",
              se = T, na.rm = T) + 
  labs(x = "Home Affordability Value", y = "Median Income ($1000)", 
       title = "Outstanding Debts HAI Distribution") +
  theme(legend.position = "none", 
        plot.title = element_text(hjust = .5))
# Arrange plots 
ggarrange(main6,
          ggarrange(dbts1, dbts2, 
                    ncol=2, labels = c(" ", " ")),
          nrow = 2, labels = " ")
```

The Outstanding Debts HAI method stands out the most with no person being able to afford housing. It is observed farthest from the affordable benchmark and as such must be displayed on a separate scale. Recall that we also increased lending-leniency to allow for 30% of monthly personal income to be spent on housing to try and compensate for the additional debts. This is consistent with the maximum possible loan amounts (relative to household income) commonly granted by 2019 financial standards yet, it marginally improves results. 

This indicates that if the debts of the average household were required to be paid immediately prior to the purchase of a house, no household in the U.S. would be able to afford the home with the current average amount of household debt under traditional financial practices. Given this HAI only considers consumer debts, which does not include mortgages, the value represents a shift in household finances towards greater debts for its goods and services even as lending practices have tightened since the 2008 financial crisis. We remove the outstanding debts HAI since the scale is not comparable to existing measures and reassess the distribution. 


```{r}
df.fin %>% 
  gather(key, value, -GeoFips, -GeoName, -year, -MEDINC, 
         -MEDVAL, -MOE, -UMEDVAL, -LMEDVAL, -POP, -PERINC, -AINCALL) %>%
  filter(key == c("HAI", "HAIRW", "HAIRNT", 
                  "HAIIPD", "HAIRAW", "HAILEN")) %>% 
  mutate(value.med = median(value)) %>% 
  ggplot(aes(value, col = key)) + 
           geom_histogram(alpha = .05) + geom_vline(xintercept = 100) + 
           facet_wrap(~key, scales = "free_x")
```

It is clear that our NAR standard (HAI) contains a dominance of MSAs that are relatively affordable and a smaller number that are not. When adjusting for inflation (HAIIPD) the portion of MSAs that contain relatively affordable housing increases. The same applies to our lenient lending practices (HAILEN). Alternatively, if we consider the prospects of affording a home by purchasing the full amount of the home’s value, fewer MSAs are affordable. Our rent adjusted (HAIRNT) and real-wage (HAIRW) exemplify similar less-affordable results. We review these methods and their relationships with the median income per MSA. 

```{r}
# Megaplots 
PMEDINC.median <- median(d$PMEDINC)
megaplot1 <- d %>% 
  filter(key != "HAIDBT") %>%
  group_by(key, Set) %>% 
  ggplot(aes(x = MMEDHAI, col = key)) + geom_point(aes(y = PMEDINC, col = key)) + 
  geom_hline(yintercept = PMEDINC.median, lty = "dotted") + 
  geom_point(aes(y = PMEDINC)) +
  facet_wrap(~Set, scales = "free") +
  geom_smooth(aes(y = PMEDINC), 
              method="loess",
              col = "grey30", 
              fill = "light grey", 
              se = T, na.rm = T, 
              lty = "solid") + 
  geom_smooth(aes(y = PMEDINC), 
              method="lm", alpha = 0.25,
              col = "grey70", 
              fill = "light blue", 
              se = F, na.rm = T, 
              lty = "dashed") + 
  labs(x = "Median HAI Value", y = "Median Income" )
megaplot2 <- d %>% 
  filter(key != "HAIDBT") %>%
  group_by(key, Set) %>% 
  ggplot(aes(x = MMEDHAI, col = key)) + geom_point(aes(y = PMEDINC, col = key)) + 
  geom_hline(yintercept = PMEDINC.median, lty = "dotted")  +
  facet_wrap(~key, scales = "free") +
  geom_smooth(aes(y = PMEDINC), 
              method="loess",
              col = "grey30", 
              fill = "light grey", 
              se = F, na.rm = T, 
              lty = "solid") + 
  geom_smooth(aes(y = PMEDINC), 
              method="lm", alpha = 0.25,
              col = "grey30", 
              fill = "light blue", 
              se = T, na.rm = T, 
              lty = "dashed") + 
  labs(x = "Median HAI Value", y = "Median Income" ) + theme(legend.position = "none")
ggarrange(megaplot1, megaplot2, nrow=2)
```

In this figure the solid black line fits a LOESS trend to the median income values per MSA and the grey dashed line represents a linear regression line of best fit. The horizontal dotted line is the median income of all MSA in its respective categories. From this, we notice for affordable areas, median income per MSA tends to increase as HAI value increases. Whereas, in less affordable areas, median income per MSA tends to decrease as HAI value increases. We also notice groups by HAI where values cluster in a columnar fashion. This implies a differing relationship between income and affordability dependent on MSA location. 

In the same figure the lighter grey area surrounding the LOESS trend and light blue area surrounding the dashed linear regression lines of best fit represents the standard error of the metrics. We use these areas as an indication of uncertainty regarding the data’s distribution and notice that there is greater certainty in linear regression than the smoothing trends, especially at localized levels as shown on the bottom half of the chart. Additionally, all HAI methods cross over their minimum affordability thresholds near 100 except for the rent-adjusted HAI which is closer to 150. The shape of the linear regressions imply that median income decreases slightly as HAI value increases (or as relative housing affordability becomes more affordable the median income for the MSA is lower). The shape of the LOESS trends tell a different story depending on the HAI. For the raw, rent adjusted, and lenient lending HAIs, the trend implies that median income increases to a certain threshold, then begins to decrease to another point, then increases minutely at the end of its distribution. Conversely, rather than displaying a wave motion of income per MSA HAI value, the NAR, inflation adjusted, and real-wage HAIs form a parabola, or widened U-shape, revealing that for their calculations, income decreases until a certain apex point, then, begins to increase at nearly the same rate.   



```{r}
# Caterpillar plots with GT100 and LT100 by Median HAI
d$year <- as.Date(paste(d$year, 12, 31, sep = "-"))
d %>% 
  filter(key != "HAIDBT") %>%
  group_by(key, Set) %>% 
  ggplot(aes(x = year, col = key)) + geom_point(aes(y = MMEDHAI, col = key)) + 
  geom_hline(yintercept = 100,  lty = "dotted") + 
  geom_line(aes(y = MMEDHAI)) +
  facet_wrap(~Set, ) +
  geom_smooth(aes(y = MMEDHAI), 
              method="lm",
              col = "grey30", 
              fill = "light grey", 
              se = T, na.rm = T, 
              lty = "solid")
d %>% 
  filter(key != "HAIDBT") %>%
  group_by(key, Set) %>% 
  ggplot(aes(x = year, col = key)) + geom_point(aes(y = MMEDHAI, col = key)) + 
  geom_hline(yintercept = 100, lty = "dotted")  +
  facet_wrap(~key, ) +
  geom_smooth(aes(y = MMEDHAI), 
              method="lm",
              col = "grey30", 
              fill = "light grey", 
              se = T, na.rm = T, 
              lty = "solid")
# Seperate Code Chunk Below
# Caterpillar plots with GT100 and LT100 by Median Income
d %>% 
  group_by(key, Set) %>% 
  ggplot(aes(x = year, col = key)) + geom_point(aes(y = PMEDINC, col = key)) + 
  geom_hline(yintercept = PMEDINC.median, lty = "dotted") + 
  geom_line(aes(y = PMEDINC)) +
  facet_wrap(~Set, scales = "free") +
  geom_smooth(aes(y = PMEDINC), 
              method="loess",
              col = "grey30", 
              fill = "light grey", 
              se = T, na.rm = T, 
              lty = "solid")
PMEDINC_reduced <- (d$PMEDINC / 1000)
PMEDINC_reduced.median <- median(PMEDINC_reduced)
d %>% 
  group_by(key, Set) %>% 
  ggplot(aes(x = year, col = key)) + geom_point(aes(y = PMEDINC_reduced, col = key)) + 
  geom_hline(yintercept = PMEDINC_reduced.median, lty = "dotted")  +
  facet_wrap(~key) +
  geom_smooth(aes(y = PMEDINC_reduced), 
              method="loess",
              col = "grey30", 
              fill = "light grey", 
              se = T, na.rm = T, 
              lty = "solid")
```

In this figure the solid black line fits a LOESS trend to the median income values per MSA and the grey dashed line represents a linear regression line of best fit. The horizontal dotted line is the median income of all MSA in its respective categories. From this, we notice for affordable areas, median income per MSA tends to increase as HAI value increases. Whereas, in less affordable areas, median income per MSA tends to decrease as HAI value increases. We also notice groups by HAI where values cluster in a columnar fashion. This implies a differing relationship between income and affordability dependent on MSA location. 

In the same figure the lighter grey area surrounding the LOESS trend and light blue area surrounding the dashed linear regression lines of best fit represents the standard error of the metrics. We use these areas as an indication of uncertainty regarding the data’s distribution and notice that there is greater certainty in linear regression than the smoothing trends, especially at localized levels as shown on the bottom half of the chart. Additionally, all HAI methods cross over their minimum affordability thresholds near 100 except for the rent-adjusted HAI which is closer to 150. The shape of the linear regressions imply that median income decreases slightly as HAI value increases (or as relative housing affordability becomes more affordable the median income for the MSA is lower). The shape of the LOESS trends tell a different story depending on the HAI. For the raw, rent adjusted, and lenient lending HAIs, the trend implies that median income increases to a certain threshold, then begins to decrease to another point, then increases minutely at the end of its distribution. Conversely, rather than displaying a wave motion of income per MSA HAI value, the NAR, inflation adjusted, and real-wage HAIs form a parabola, or widened U-shape, revealing that for their calculations, income decreases until a certain apex point, then, begins to increase at nearly the same rate.  


## Discussion 


## Conclusion

















